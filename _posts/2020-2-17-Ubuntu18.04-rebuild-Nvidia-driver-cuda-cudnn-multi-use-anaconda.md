---
title: Ubuntu18.04é‡è£…Nvidiaé©±åŠ¨ï¼Œcudaå’Œcudnnï¼Œå¤šç”¨æˆ·ä½¿ç”¨anaconda
tags: enviroment-setup
layout: article
aside:
  toc: true
key: 2020-2-17-Ubuntu18-rebuild-Nvidiadriver
show_title: true
---

æœ€è¿‘æ‰‹æ®‹å‡çº§äº†nvidiaæ˜¾å¡é©±åŠ¨ï¼Œå¯¼è‡´cudaä¸é©±åŠ¨å†²åŠ¨ï¼Œæ²¡åŠæ³•åªèƒ½é‡è£…äº†ã€‚
<!--more-->
é…ç½®ä¿¡æ¯ï¼š<br>ç³»ç»Ÿï¼šUbuntu18.04ï¼›æ˜¾å¡ï¼šNvidia 2080Tiï¼›é©±åŠ¨ï¼šNvidia Driver 440.44ï¼›cudaï¼š10.2ï¼›cudnnï¼š7.6.5

<img src="https://jinluzhang.site/PublicPic/Pic/image-20200108100525530.png" alt="img" style="zoom:80%;" />

æŸ¥çœ‹cuda ç‰ˆæœ¬
cat /usr/local/cuda/version.txt

æŸ¥çœ‹cudnn ç‰ˆæœ¬
cat /usr/local/cuda/include/cudnn.h | grep CUDNN_MAJOR -A 2

![image-20200108100752066](https://jinluzhang.site/PublicPic/Pic/image-20200108100752066-1581941094214.png)

## é‡è£…æ˜¾å¡é©±åŠ¨

### ç¦ç”¨nouveaué©±åŠ¨

```sudo vim /etc/modprobe.d/blacklist.conf```
åœ¨æ–‡æœ¬æœ€åæ·»åŠ ï¼š

```
blacklist nouveau
options nouveau modeset=0
```

ç„¶åæ‰§è¡Œï¼š```sudo update-initramfs -u```

é‡å¯æœºå™¨åï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå¦‚æœæ²¡æœ‰å±å¹•è¾“å‡ºï¼Œè¯´æ˜ç¦ç”¨nouveauæˆåŠŸï¼š

```lsmod | grep nouveau```

### ä¸‹è½½é©±åŠ¨

å®˜ç½‘ä¸‹è½½åœ°å€ï¼šhttps://www.nvidia.cn/Download/index.aspx?lang=cn ï¼Œæ ¹æ®è‡ªå·±æ˜¾å¡çš„æƒ…å†µä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„æ˜¾å¡é©±åŠ¨ã€‚ä¸‹è½½å¾—åˆ°ä¸€ä¸ª.runå®‰è£…åŒ…ï¼Œä¹‹åä¼šç”¨åˆ°ã€‚

### å¸è½½æ—§é©±åŠ¨

é‡å¯åï¼Œä½¿ç”¨å¿«æ·é”®è¿›å…¥æ–‡æœ¬æ¨¡å¼ï¼Œç„¶åè¾“å…¥ç”¨æˆ·åå¯†ç å°±å¯ï¼š`Ctrl-Alt+F1`

æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ç¦ç”¨X-WindowæœåŠ¡ï¼Œå¦åˆ™æ— æ³•å®‰è£…æ˜¾å¡é©±åŠ¨ï¼š`sudo service lightdm stop`

æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å¸è½½åŸæœ‰æ˜¾å¡é©±åŠ¨ï¼šæ³¨æ„åŒ¹é…è‡ªå·±ä¸‹è½½çš„é©±åŠ¨ç‰ˆæœ¬

```
sudo apt-get remove --purge nvidia*
sudo apt-get autoremove
sudo chmod +x NVIDIA-Linux-x86_64-4**.**.run
sudo ./NVIDIA-Linux-x86_64-4**.**.run --uninstall
```

### å®‰è£…æ–°é©±åŠ¨

ä¿é™©æœŸé—´ï¼Œå†é‡å¯ä¸€éã€‚ç›´æ¥æ‰§è¡Œé©±åŠ¨æ–‡ä»¶å³å¯å®‰è£…æ–°é©±åŠ¨ï¼Œä¸€ç›´é»˜è®¤å³å¯ï¼š

```text
sudo ./NVIDIA-Linux-x86_64-410.93.run
```

æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å¯åŠ¨X-WindowæœåŠ¡

```text
sudo service lightdm start
```

æœ€åæ‰§è¡Œé‡å¯å‘½ä»¤ï¼Œé‡å¯ç³»ç»Ÿå³å¯ï¼š

```
reboot
```

## é‡è£…CUDA

å› ä¸ºé‡è£…åçš„é©±åŠ¨å’ŒåŸæ¥CUDAç‰ˆæœ¬è¿˜æ˜¯ä¸ä¸€æ ·ï¼ˆå¦‚æœä¹‹å‰å®‰è£…äº†CUDAï¼Œå¯ä»¥ç”¨```nvcc -V```è¯•è¯•ï¼Œä¸è¡Œçš„è¯è¿˜æ˜¯é‡è£…å§â€‹ğŸ™‚â€‹ï¼‰

å¸è½½CUDAæ‰§è¡Œçš„æ˜¯CUDAè‡ªå¸¦çš„å¸è½½è„šæœ¬ï¼Œè¯»è€…è¦æ ¹æ®è‡ªå·±çš„cudaç‰ˆæœ¬æ‰¾åˆ°å¸è½½è„šæœ¬ï¼š

```sudo /usr/local/cuda-10.0/bin/uninstall_cuda_10.0.pl```
å¸è½½ä¹‹åï¼Œè¿˜æœ‰ä¸€äº›æ®‹ç•™çš„æ–‡ä»¶å¤¹ï¼Œä¹‹å‰å®‰è£…çš„æ˜¯CUDA 8.0ã€‚å¯ä»¥ä¸€å¹¶åˆ é™¤ï¼š

```sudo rm -rf /usr/local/cuda-10.0/```

## å®‰è£…CUDA

### ä¸‹è½½å®‰è£…

åœ¨å®˜ç½‘ï¼š[CUDAä¸‹è½½é¡µé¢](https://developer.nvidia.com/cuda-downloads?target_os=Linux&target_arch=x86_64&target_distro=Ubuntu&target_version=1604&target_type=runfilelocal)ï¼Œä¸‹è½½ç¬¦åˆè‡ªå·±ç³»ç»Ÿç‰ˆæœ¬çš„CUDAã€‚

ä¸‹è½½å®Œæˆä¹‹åï¼Œç»™æ–‡ä»¶èµ‹äºˆæ‰§è¡Œæƒé™ï¼š

```text
chmod +x cuda_*****_linux.run
```

æ‰§è¡Œå®‰è£…åŒ…ï¼Œå¼€å§‹å®‰è£…ï¼š

```text
./cuda_****_linux.run
```

CUDA10.2å®‰è£…æ—¶ä¼šæ˜¾ç¤ºè¿™æ ·ä¸€ä¸ªç”»é¢ğŸ‘‡ï¼Œä¸å®‰è£…é©±åŠ¨äº†ï¼Œæ³¨æ„æŠŠDriverå»æ‰ï¼Œå¦åˆ™ä¼šå¯¼è‡´é‡å¤å®‰è£…é©±åŠ¨

<img src="https://jinluzhang.site/PublicPic/Pic/image-20200107223538310.png" style="zoom: 80%;" />

### é…ç½®ç¯å¢ƒå˜é‡

```
export CUDA_HOME=/usr/local/cuda-10.2
export LD_LIBRARY_PATH=${CUDA_HOME}/lib64
export PATH=${CUDA_HOME}/bin:${PATH}
```

## å®‰è£…CUDNN

CUDNNçš„ä¸‹è½½å®˜ç½‘ï¼šhttps://developer.nvidia.com/rdp/cudnn-download ï¼Œç‚¹å‡»Downloadå¼€å§‹é€‰æ‹©å’ŒCUDA10.2åŒ¹é…çš„ä¸‹è½½ç‰ˆæœ¬ï¼Œé€‰æ‹©`cuDNN Library for Linux`ï¼š

å¯¹å®ƒè¿›è¡Œè§£å‹ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š

tar -zxvf cudnn-10.0-linux-x64-v7.4.2.24.tgz 

è§£å‹ä¹‹åå¯ä»¥å¾—åˆ°ä»¥ä¸‹æ–‡ä»¶ï¼š

> cuda/include/cudnn.h
> cuda/NVIDIA_SLA_cuDNN_Support.txt
> cuda/lib64/libcudnn.so
> cuda/lib64/libcudnn.so.7
> cuda/lib64/libcudnn.so.7.4.2
> cuda/lib64/libcudnn_static.a

ä½¿ç”¨ä»¥ä¸‹ä¸¤æ¡å‘½ä»¤å¤åˆ¶è¿™äº›æ–‡ä»¶åˆ°CUDAç›®å½•ä¸‹ï¼š

```
cp cuda/lib64/* /usr/local/cuda-10.0/lib64/
cp cuda/include/* /usr/local/cuda-10.0/include/
```

æ‹·è´å®Œæˆä¹‹åï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹CUDNNçš„ç‰ˆæœ¬ä¿¡æ¯ï¼š

```
cat /usr/local/cuda/include/cudnn.h | grep CUDNN_MAJOR -A 2
```



## å®‰è£…Anaconda3

å…ˆå»å®˜æ–¹åœ°å€ä¸‹è½½å¥½å¯¹åº”çš„å®‰è£…åŒ…[Ubuntu - anaconda ä¸‹è½½åœ°å€](https://www.anaconda.com/download/#linux)

ç„¶åç›´æ¥å®‰è£…anaconda ï¼š`bash ~/Downloads/Anaconda3-5.2.0-Linux-x86_64.sh`

å®‰è£…è¿‡ç¨‹ä¸­çœ‹åˆ°

> Welcome to Anaconda3 5.2.0
> In order to continue the installation process, please review the license
> agreement. (ä¸ºäº†ç»§ç»­å®‰è£…è¿‡ç¨‹ï¼Œè¯·å®¡æ ¸è®¸å¯è¯ã€‚åè®®ã€‚)
> Please, press ENTER to continue

ç›´æ¥æŒ‰enteræŸ¥çœ‹åè®®ï¼Œç„¶åä¸€ç›´enterä¸‹å»ï¼Œ

ç„¶åçœ‹åˆ°

> Do you accept the license terms? [yes|no]ï¼ˆä½ æ¥å—è®¸å¯è¯æ¡æ¬¾å—?ï¼‰

ç›´æ¥è¾“å…¥yes ç„¶åæŒ‰enterï¼Œè¿›å…¥ä¸‹ä¸€æ­¥

æ¥ä¸‹æ¥ä¼šæç¤ºå®‰è£…åœ°å€ï¼š

> Anaconda3 will now be installed into this location:
> /home/user/anaconda3
>
> Press ENTER to confirm the location
> Press CTRL-C to abort the installation
> Or specify a different location below

å»ºè®®é»˜è®¤å³å¯ï¼Œ
æŒ‰enterç»§ç»­ä¸‹ä¸€æ­¥ï¼Œæ³¨æ„è¿™é‡ŒæŒ‰ctrl + c ç›´æ¥ä¼šç»ˆæ­¢å®‰è£…ã€‚
æ¥ä¸‹æ¥å…ˆç­‰å¾…å®‰è£…å³å¯ã€‚
çœ‹åˆ°

> Thank you for installing Anaconda3! 

è¡¨ç¤ºå®‰è£…æˆåŠŸã€‚

### æ·»åŠ ç¯å¢ƒå˜é‡

anacondaä¼šè‡ªåŠ¨å°†ç¯å¢ƒå˜é‡æ·»åŠ åˆ°PATHé‡Œé¢ï¼Œå¦‚æœåé¢ä½ å‘ç°è¾“å‡ºconda
æç¤ºæ²¡æœ‰è¯¥å‘½ä»¤ï¼Œé‚£ä¹ˆä½ éœ€è¦source ~/.bashrc è¿™æ ·å°±æ˜¯æ›´æ–°ç¯å¢ƒå˜é‡ï¼Œå°±å¯ä»¥æ­£å¸¸ä½¿ç”¨äº†ã€‚
å¦‚æœå‘ç°è¿™æ ·è¿˜æ˜¯æ²¡ç”¨ï¼Œé‚£ä¹ˆéœ€è¦æ”¶åˆ°æ·»åŠ ç¯å¢ƒå˜é‡
`sudo vim ~/.basrc` æ–‡ä»¶ï¼Œåœ¨æœ€åé¢åŠ ä¸Š
`export PATH=/home/user/anaconda3/bin:$PATH`

ä¿å­˜é€€å‡ºåï¼šsource ~/.bashrc
å†æ¬¡è¾“å…¥conda listæµ‹è¯•çœ‹çœ‹ï¼Œåº”è¯¥å°±æ˜¯æ²¡æœ‰é—®é¢˜å•¦ï¼

## å¤šç”¨æˆ·ä½¿ç”¨conda

æ³¨æ„æˆ‘åœ¨userç”¨æˆ·ä¸‹å®‰è£…é…ç½®çš„condaï¼Œæ€ä¹ˆåœ¨å…¶ä»–ç”¨æˆ·é‡Œä½¿ç”¨condaå‘¢ï¼Ÿç›´æ¥ä½¿ç”¨ä¼šæŠ¥é”™æ²¡æœ‰condaå‘½ä»¤

åšå¦‚ä¸‹é…ç½®ï¼š

```
su another_user
sudo vim ~/.basrc
```

æœ€åä¸€è¡ŒåŠ ä¸Šcondaå®‰è£…ä½ç½®çš„ç¯å¢ƒå˜é‡ï¼šexport PATH=/home/user/anaconda3/bin:$PATH

ä¿å­˜é€€å‡ºåï¼šsource ~/.bashrc

å¦‚æœä½¿ç”¨conda activateå‘½ä»¤æ˜¾ç¤ºæ²¡æœ‰åˆå§‹åŒ–è¿™æ ·çš„é”™è¯¯ï¼Œè¿è¡Œä¸‹é¢ä»£ç ï¼š

```bash
source ~/anaconda3/etc/profile.d/conda.sh
conda activate my_env
```